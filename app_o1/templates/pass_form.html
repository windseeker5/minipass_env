{% extends "base.html" %}
{% block title %}{{ "Edit" if hockey_pass else "Create" }} Pass{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
  <div class="col-lg-8">


    <form method="POST" class="card shadow-sm border bg-white">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      

      <div class="card-header d-flex align-items-center justify-content-between">
        <h3 class="card-title mb-0">
          {{ "Update Digital Pass" if hockey_pass else "Create a New Digital Pass" }}
        </h3>
        <i class="ti ti-user-square-rounded fs-1 text-muted"></i>
      </div>
      
      <div class="card-body">

        <!-- 🧑 User Info -->
        <fieldset class="form-fieldset mb-4">
          <legend>User Information</legend>

          <!-- User Name -->
          <div class="mb-3 position-relative input-icon">
            <span class="input-icon-addon"><i class="ti ti-user"></i></span>
            <input type="text" name="user_name" id="user_name" class="form-control" placeholder="Full Name" autocomplete="off" required
                   value="{{ hockey_pass.user_name if hockey_pass else '' }}" />
            <div id="suggestions" class="list-group position-absolute w-100 shadow bg-white border rounded" style="top: 100%; z-index: 10;"></div>
          </div>

          <!-- Email -->
          <div class="mb-3 input-icon">
            <span class="input-icon-addon"><i class="ti ti-mail"></i></span>
            <input type="email" name="user_email" id="user_email" class="form-control" placeholder="Email" required
                   value="{{ hockey_pass.user_email if hockey_pass else '' }}" />
          </div>

          <!-- Phone Number -->
          <div class="mb-3 input-icon">
            <span class="input-icon-addon"><i class="ti ti-phone"></i></span>
            <input type="tel" name="phone_number" id="mobile_phone" class="form-control" placeholder="Phone Number" required
                   value="{{ hockey_pass.phone_number if hockey_pass else '' }}" />
          </div>
        </fieldset>

        <!-- 🎟 Pass Info -->
        <fieldset class="form-fieldset mb-4">
          <legend>Pass Details</legend>

          <!-- Activity -->
          <div class="mb-3">
            <label class="form-label">Activity <span class="text-danger">*</span></label>
            <select name="activity" class="form-select" required>
              <option value="">-- Select Activity --</option>
              {% for activity in activity_list %}
                <option value="{{ activity }}"
                  {% if hockey_pass and hockey_pass.activity == activity %}selected{% endif %}>{{ activity }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Amount -->
          <div class="mb-3 input-icon">
            <span class="input-icon-addon"><i class="ti ti-currency-dollar"></i></span>
            <input type="number" name="sold_amt" step="0.01" class="form-control" placeholder="Amount" required
                   value="{{ hockey_pass.sold_amt if hockey_pass else default_amt }}" />
          </div>

          <!-- Sessions Quantity -->
          <div class="mb-3 input-icon">
            <span class="input-icon-addon"><i class="ti ti-list-numbers"></i></span>
            <input type="number" name="games_remaining" class="form-control" placeholder="Number of Games" required
                   value="{{ hockey_pass.games_remaining if hockey_pass else default_qt }}" />
          </div>




          <!-- Notes -->
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea name="notes" id="notes" rows="3" class="form-control">{{ hockey_pass.notes if hockey_pass else '' }}</textarea>
          </div>
        </fieldset>
      </div>

      <div class="card-footer text-end">
        <button type="submit" class="btn btn-primary">
          <i class="ti ti-ticket me-2"></i>{{ "Update Pass" if hockey_pass else "Create Pass" }}
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let userCache = [];
    const nameInput = document.getElementById("user_name");
    const emailInput = document.getElementById("user_email");
    const phoneInput = document.getElementById("mobile_phone");
    const suggestionBox = document.getElementById("suggestions");

    fetch("/users.json")
      .then(response => response.json())
      .then(data => userCache = data)
      .catch(err => console.error("❌ Failed to load user cache:", err));

    nameInput.addEventListener("input", () => {
      const input = nameInput.value.trim().toLowerCase();
      if (input.length < 2) return suggestionBox.classList.remove("show");

      const matches = userCache.filter(user =>
        user.name && user.name.toLowerCase().startsWith(input)
      ).slice(0, 5);

      suggestionBox.innerHTML = "";
      if (matches.length > 0) {
        matches.forEach(user => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "list-group-item list-group-item-action text-start";
          btn.textContent = user.name;
          btn.dataset.email = user.email;
          btn.dataset.phone = user.phone;
          btn.addEventListener("click", () => {
            nameInput.value = user.name;
            emailInput.value = user.email;
            phoneInput.value = user.phone;
            suggestionBox.classList.remove("show");
          });
          suggestionBox.appendChild(btn);
        });
        suggestionBox.classList.add("show");
      } else {
        suggestionBox.classList.remove("show");
      }
    });

    document.addEventListener("click", (e) => {
      if (!suggestionBox.contains(e.target) && e.target !== nameInput) {
        suggestionBox.classList.remove("show");
      }
    });
  });
</script>
{% endblock %}
