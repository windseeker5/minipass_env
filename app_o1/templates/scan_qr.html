{% extends "base.html" %}
{% block title %}Scan QR Code | Minipass{% endblock %}

{% block content %}
<div class="container-xl mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h3 class="card-title mb-0">
            <i class="ti ti-scan me-2"></i>Scan Pass QR Code
          </h3>
          <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">
            <i class="ti ti-arrow-left me-1"></i>Back
          </a>
        </div>

        <div class="card-body">
          <!-- Hidden CSRF token -->
          <input type="hidden" id="csrf_token" value="{{ csrf_token() }}">

          <!-- Camera Select -->
          <div class="mb-3">
            <label for="camera-select" class="form-label">Select Camera</label>
            <select id="camera-select" class="form-select"></select>
          </div>

          <!-- QR Video -->
          <div class="ratio ratio-4x3 border rounded overflow-hidden mb-3">
            <video id="qr-video" autoplay playsinline class="w-100 h-100 object-fit-cover"></video>
          </div>

          <!-- QR Result -->
          <div id="qr-result" class="alert alert-secondary text-center" role="alert">
            <i class="ti ti-clock-hour-4 me-2"></i>Waiting for scan...
          </div>

          <audio id="beep-sound" src="{{ url_for('static', filename='beep.wav') }}"></audio>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- QR Scanner JS -->
<script src="https://unpkg.com/jsqr"></script>
<script>
  const video = document.getElementById("qr-video");
  const canvas = document.createElement("canvas");
  const context = canvas.getContext("2d");
  const resultDisplay = document.getElementById("qr-result");
  const cameraSelect = document.getElementById("camera-select");
  const beepSound = document.getElementById("beep-sound");

  let lastScanned = "";
  let scanning = false;

  async function listCameras() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(d => d.kind === "videoinput");

    cameraSelect.innerHTML = "";
    videoDevices.forEach((device, index) => {
      const option = document.createElement("option");
      option.value = device.deviceId;
      option.text = device.label || `Camera ${index + 1}`;
      cameraSelect.appendChild(option);
    });

    if (videoDevices.length > 0) {
      startScanner(videoDevices[0].deviceId);
    }
  }

  async function startScanner(deviceId = null) {
    try {
      const constraints = deviceId
        ? { video: { deviceId: { exact: deviceId } } }
        : { video: { facingMode: "environment" } };

      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      scanning = true;
      requestAnimationFrame(scanLoop);
    } catch (err) {
      resultDisplay.className = "alert alert-danger text-center";
      resultDisplay.innerHTML = `<i class="ti ti-alert-triangle me-2"></i>Camera access denied`;
    }
  }

  function scanLoop() {
    if (!scanning) return;

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);

      if (code && lastScanned !== code.data) {
        lastScanned = code.data;
        beepSound.play();
        resultDisplay.className = "alert alert-success text-center";
        resultDisplay.innerHTML = `<i class="ti ti-check me-2"></i>Pass Scanned: ${code.data}`;

        scanning = false;

        // Show loading
        resultDisplay.innerHTML += "<br><small>Processing...</small>";

        setTimeout(() => {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `/redeem-qr/${code.data}`;

          // Add CSRF token
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrf_token';
          csrfInput.value = document.getElementById('csrf_token').value;
          form.appendChild(csrfInput);

          document.body.appendChild(form);
          form.submit();
        }, 600);
      }
    }
    requestAnimationFrame(scanLoop);
  }

  cameraSelect.addEventListener("change", () => {
    const selected = cameraSelect.value;
    startScanner(selected);
  });

  document.addEventListener("DOMContentLoaded", listCameras);
</script>
{% endblock %}
