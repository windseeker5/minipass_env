# Email Security Filters for Fail2Ban
# Custom filter definitions for enhanced email security monitoring
#
# These filters should be placed in /etc/fail2ban/filter.d/ as individual .conf files
# Each filter section should be saved as a separate file (e.g., postfix-sasl.conf)
#
# Author: Python DevOps Automation Specialist
# Created: 2025-08-02
# Version: 2.0.0 (Security Enhanced)

# =============================================================================
# POSTFIX FILTERS
# =============================================================================

# File: /etc/fail2ban/filter.d/postfix-sasl.conf
[postfix-sasl]
# Enhanced SASL authentication failure detection
failregex = ^%(__prefix_line)swarning: [-._\w]+\[<HOST>\]: SASL (?:LOGIN|PLAIN|(?:CRAM|DIGEST)-MD5) authentication failed(?:: [ -~]*)?$
            ^%(__prefix_line)swarning: [-._\w]+\[<HOST>\]: SASL authentication failed$
            ^%(__prefix_line)srejecting SASL login from [-._\w]+\[<HOST>\]$
            ^%(__prefix_line)swarning: [-._\w]+\[<HOST>\]: SASL authentication failure: [-._\w]+$
            ^%(__prefix_line)swarning: unknown\[<HOST>\]: SASL (?:LOGIN|PLAIN|(?:CRAM|DIGEST)-MD5) authentication failed$

ignoreregex = 

# File: /etc/fail2ban/filter.d/postfix-rbl.conf
[postfix-rbl]
# RBL bypass and reputation attack detection
failregex = ^%(__prefix_line)sREJECT.*\[<HOST>\].*Service unavailable; Client host \[<HOST>\] blocked$
            ^%(__prefix_line)sREJECT.*\[<HOST>\].*listed by domain.*$
            ^%(__prefix_line)sREJECT.*\[<HOST>\].*Client host rejected: cannot find your hostname$
            ^%(__prefix_line)sREJECT.*from [-._\w]+\[<HOST>\].*RBL.*$
            ^%(__prefix_line)sREJECT.*from [-._\w]+\[<HOST>\].*Sender address rejected: Domain not found$

ignoreregex = 

# File: /etc/fail2ban/filter.d/postfix-relay.conf
[postfix-relay]
# Unauthorized relay attempt detection
failregex = ^%(__prefix_line)sREJECT.*\[<HOST>\].*Relay access denied$
            ^%(__prefix_line)sREJECT.*from [-._\w]+\[<HOST>\].*relay access denied$
            ^%(__prefix_line)sNOQUEUE: reject: RCPT from [-._\w]+\[<HOST>\].*relay access denied$
            ^%(__prefix_line)swarning: [-._\w]+\[<HOST>\]: address not listed for hostname$
            ^%(__prefix_line)sREJECT.*\[<HOST>\].*: Sender address rejected: not owned by user$

ignoreregex = 

# File: /etc/fail2ban/filter.d/postfix-spam.conf
[postfix-spam]
# Spam injection and content filtering bypass detection
failregex = ^%(__prefix_line)sREJECT.*\[<HOST>\].*Message rejected for spam$
            ^%(__prefix_line)sREJECT.*from [-._\w]+\[<HOST>\].*content rejected$
            ^%(__prefix_line)sREJECT.*\[<HOST>\].*: header .* from [-._\w]+\[<HOST>\]; proto=ESMTP.*$
            ^%(__prefix_line)sblocked using .*\[<HOST>\]$
            ^%(__prefix_line)sREJECT.*\[<HOST>\].*Message contains spam or virus$

ignoreregex = 

# File: /etc/fail2ban/filter.d/postfix-ratelimit.conf
[postfix-ratelimit]
# Connection rate limiting detection
failregex = ^%(__prefix_line)swarning: [-._\w]+\[<HOST>\]: Connection rate limit exceeded$
            ^%(__prefix_line)swarning: Connection concurrency limit exceeded .* from \[<HOST>\]$
            ^%(__prefix_line)swarning: Connection rate limit exceeded from \[<HOST>\]$
            ^%(__prefix_line)sREJECT.*\[<HOST>\].*: Client host rejected: too many connections$

ignoreregex = 

# =============================================================================
# DOVECOT FILTERS
# =============================================================================

# File: /etc/fail2ban/filter.d/dovecot-auth.conf
[dovecot-auth]
# Enhanced Dovecot authentication failure detection
failregex = ^%(__prefix_line)s(?:auth-worker\(\d+\):)?\s*auth-worker(?:\(\d+\))?: auth failed, \d+ attempts in \d+ secs: user=<[^>]*>, method=\w+, rip=<HOST>, lip=[\d.]+(?:, session=<\w+>)?$
            ^%(__prefix_line)s(?:auth-worker\(\d+\):)?\s*auth failed, (?:\d+ attempts in \d+ secs: )?user=<[^>]*>, method=\w+, rip=<HOST>, lip=[\d.]+$
            ^%(__prefix_line)s(?:auth-worker\(\d+\):)?\s*auth-worker(?:\(\d+\))?: Password mismatch.*rip=<HOST>$
            ^%(__prefix_line)s(?:auth-worker\(\d+\):)?\s*auth failed.*rip=<HOST>.*$
            ^%(__prefix_line)s(?:auth|auth-worker)(?:\(\d+\))?: (?:pam\(\S+,<HOST>(?:,\S*)?\): pam_authenticate\(\) failed|passwd-file\(\S+,<HOST>(?:,\S*)?\): unknown user|passwd\(\S+,<HOST>(?:,\S*)?\): unknown user|unknown user).*$

ignoreregex = 

# File: /etc/fail2ban/filter.d/dovecot-pop3-imap.conf
[dovecot-pop3-imap]
# POP3/IMAP specific attack detection
failregex = ^%(__prefix_line)s(?:pop3|imap)-login: (?:Disconnected|Aborted login \(auth failed|Aborted login \(tried to use non-plaintext|Aborted login \(tried to use disabled|Authentication failure).*rip=<HOST>.*$
            ^%(__prefix_line)s(?:pop3|imap)-login: Disconnected \(auth failed, \d+ attempts in \d+ secs\):.*rip=<HOST>.*$
            ^%(__prefix_line)s(?:pop3|imap)-login: Aborted login.*rip=<HOST>.*$
            ^%(__prefix_line)s(?:pop3|imap): Error: .*authentication failed.*remote=<HOST>$

ignoreregex = 

# =============================================================================
# EXIM FILTERS
# =============================================================================

# File: /etc/fail2ban/filter.d/exim-spam.conf
[exim-spam]
# Exim spam and content filtering detection
failregex = ^%(__prefix_line)s\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2} \S+ rejected RCPT.*<HOST>.*$
            ^%(__prefix_line)s\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2} \S+ spam detected.*\[<HOST>\].*$
            ^%(__prefix_line)s\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2} rejected .*from.*\[<HOST>\].*$

ignoreregex = 

# =============================================================================
# WEBMAIL FILTERS
# =============================================================================

# File: /etc/fail2ban/filter.d/roundcube-auth.conf
[roundcube-auth]
# Roundcube webmail authentication failures
failregex = ^\[.*\] <HOST> Roundcube: \[.*\] Failed login for .* from <HOST>.*$
            ^\[.*\] <HOST> .*IMAP Error: Login failed for .* from <HOST>.*$
            ^\[.*\] <HOST> .*Authentication failed for .* from <HOST>.*$
            ^.*\[<HOST>\] .*Authentication failed.*$
            ^.*Roundcube.*Failed login.*from <HOST>.*$

ignoreregex = 

# File: /etc/fail2ban/filter.d/squirrelmail.conf
[squirrelmail]
# SquirrelMail webmail attack detection
failregex = ^<HOST>.*"POST /squirrelmail/src/redirect\.php.*" 200.*$
            ^<HOST>.*"POST /squirrelmail/src/login\.php.*" 200.*$
            ^<HOST>.*squirrelmail.*login.*failed.*$

ignoreregex = 

# =============================================================================
# GENERIC EMAIL SECURITY FILTERS
# =============================================================================

# File: /etc/fail2ban/filter.d/email-brute-force.conf
[email-brute-force]
# Generic email service brute force detection
failregex = ^%(__prefix_line)s.*authentication failed.*<HOST>.*$
            ^%(__prefix_line)s.*login failed.*<HOST>.*$
            ^%(__prefix_line)s.*auth failed.*<HOST>.*$
            ^%(__prefix_line)s.*LOGIN failed.*<HOST>.*$
            ^%(__prefix_line)s.*Authentication failure.*<HOST>.*$

ignoreregex = 

# File: /etc/fail2ban/filter.d/email-dos.conf
[email-dos]
# Email service DoS attack detection
failregex = ^%(__prefix_line)s.*too many connections.*<HOST>.*$
            ^%(__prefix_line)s.*connection limit.*<HOST>.*$
            ^%(__prefix_line)s.*rate limit.*<HOST>.*$
            ^%(__prefix_line)s.*connection flood.*<HOST>.*$

ignoreregex = 

# File: /etc/fail2ban/filter.d/email-directory-harvest.conf
[email-directory-harvest]
# Directory harvest attack detection
failregex = ^%(__prefix_line)sREJECT.*\[<HOST>\].*User unknown in.*table$
            ^%(__prefix_line)sREJECT.*\[<HOST>\].*Recipient address rejected: User unknown$
            ^%(__prefix_line)sREJECT.*from [-._\w]+\[<HOST>\].*User unknown$
            ^%(__prefix_line)sREJECT.*\[<HOST>\].*address rejected: User unknown in local recipient table$
            ^%(__prefix_line)sNOQUEUE: reject: RCPT from [-._\w]+\[<HOST>\].*User unknown in virtual mailbox table$

ignoreregex = 

# File: /etc/fail2ban/filter.d/email-content-filter-bypass.conf
[email-content-filter-bypass]
# Content filter bypass attempt detection
failregex = ^%(__prefix_line)s.*amavis.*INFECTED.*<HOST>.*$
            ^%(__prefix_line)s.*content filter.*reject.*<HOST>.*$
            ^%(__prefix_line)s.*virus.*detected.*<HOST>.*$
            ^%(__prefix_line)s.*malware.*found.*<HOST>.*$
            ^%(__prefix_line)s.*content.*rejected.*<HOST>.*$

ignoreregex = 

# File: /etc/fail2ban/filter.d/email-reputation-bypass.conf
[email-reputation-bypass]
# Reputation system bypass detection
failregex = ^%(__prefix_line)s.*reputation.*reject.*<HOST>.*$
            ^%(__prefix_line)s.*blacklist.*<HOST>.*$
            ^%(__prefix_line)s.*DNSBL.*<HOST>.*$
            ^%(__prefix_line)s.*RBL.*reject.*<HOST>.*$
            ^%(__prefix_line)s.*sender.*reputation.*<HOST>.*$

ignoreregex = 

# =============================================================================
# INSTALLATION INSTRUCTIONS
# =============================================================================

# To install these filters:
#
# 1. Create individual filter files in /etc/fail2ban/filter.d/
#    Example: sudo nano /etc/fail2ban/filter.d/postfix-sasl.conf
#
# 2. Copy the appropriate [filter-name] section to each file
#
# 3. Test the filter:
#    sudo fail2ban-regex /var/log/mail.log /etc/fail2ban/filter.d/postfix-sasl.conf
#
# 4. Reload fail2ban:
#    sudo systemctl reload fail2ban
#
# 5. Check jail status:
#    sudo fail2ban-client status postfix-sasl

# =============================================================================
# TESTING AND VALIDATION
# =============================================================================

# Test commands for each filter:
# sudo fail2ban-regex /var/log/mail.log /etc/fail2ban/filter.d/postfix-sasl.conf
# sudo fail2ban-regex /var/log/mail.log /etc/fail2ban/filter.d/postfix-relay.conf
# sudo fail2ban-regex /var/log/dovecot.log /etc/fail2ban/filter.d/dovecot-auth.conf

# Monitor active bans:
# sudo fail2ban-client status
# sudo fail2ban-client status postfix-sasl
# sudo iptables -L f2b-postfix-sasl -n

# =============================================================================
# SECURITY NOTES
# =============================================================================

# 1. Regularly review and update regex patterns based on new attack vectors
# 2. Monitor false positives and adjust patterns accordingly
# 3. Consider implementing custom actions for different threat levels
# 4. Use geographic IP blocking for persistent international threats
# 5. Implement honeypot email addresses to detect directory harvest attacks
# 6. Monitor for distributed attacks across multiple IP addresses
# 7. Consider integration with threat intelligence feeds for known bad actors