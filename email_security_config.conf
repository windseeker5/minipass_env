# Enhanced Email Service Security Configuration for Fail2Ban
# This configuration provides comprehensive protection for email services
# including SMTP, IMAP, POP3, and related protocols

# =============================================================================
# POSTFIX SMTP PROTECTION
# =============================================================================

[postfix-sasl]
# Protects against SMTP authentication brute force attacks
enabled = true
port = smtp,465,587,submission
filter = postfix-sasl
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 3
bantime = 3600
findtime = 600
action = iptables-multiport[name=postfix-sasl, port="smtp,465,587,submission"]
         sendmail-whois-lines[name=postfix-sasl, dest=admin@%(domain)s, logpath=%(logpath)s]

[postfix-rbl]
# Protects against RBL bypass attempts and relay abuse
enabled = true
port = smtp,465,587,submission
filter = postfix-rbl
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 1
bantime = 86400
findtime = 300
action = iptables-multiport[name=postfix-rbl, port="smtp,465,587,submission"]

[postfix-auth]
# General postfix authentication failures
enabled = true
port = smtp,465,587,submission
filter = postfix
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 5
bantime = 1800
findtime = 300
action = iptables-multiport[name=postfix-auth, port="smtp,465,587,submission"]

[postfix-relay]
# Prevents mail relay abuse attempts
enabled = true
port = smtp,465,587,submission
filter = postfix-relay
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 2
bantime = 7200
findtime = 600
action = iptables-multiport[name=postfix-relay, port="smtp,465,587,submission"]

# =============================================================================
# DOVECOT IMAP/POP3 PROTECTION
# =============================================================================

[dovecot-auth]
# Protects against IMAP/POP3 authentication brute force
enabled = true
port = pop3,pop3s,imap,imaps,submission,465,sieve
filter = dovecot
logpath = /var/log/mail.log
          /var/log/dovecot.log
maxretry = 3
bantime = 3600
findtime = 600
action = iptables-multiport[name=dovecot-auth, port="pop3,pop3s,imap,imaps,submission,465,sieve"]
         sendmail-whois-lines[name=dovecot-auth, dest=admin@%(domain)s, logpath=%(logpath)s]

[dovecot-aggressive]
# More aggressive protection for persistent attackers
enabled = true
port = pop3,pop3s,imap,imaps
filter = dovecot
logpath = /var/log/mail.log
          /var/log/dovecot.log
maxretry = 10
bantime = 86400
findtime = 3600
action = iptables-multiport[name=dovecot-aggressive, port="pop3,pop3s,imap,imaps"]

# =============================================================================
# COURIER MAIL SERVER PROTECTION (if using Courier)
# =============================================================================

[courier-auth]
enabled = false  # Enable if using Courier
port = pop3,pop3s,imap,imaps
filter = courier-auth
logpath = /var/log/mail.log
maxretry = 3
bantime = 3600
findtime = 600
action = iptables-multiport[name=courier-auth, port="pop3,pop3s,imap,imaps"]

[courier-smtp]
enabled = false  # Enable if using Courier SMTP
port = smtp,465,587
filter = courier-smtp
logpath = /var/log/mail.log
maxretry = 3
bantime = 3600
findtime = 600
action = iptables-multiport[name=courier-smtp, port="smtp,465,587"]

# =============================================================================
# WEBMAIL PROTECTION
# =============================================================================

[squirrelmail]
# Protects SquirrelMail webmail interface
enabled = false  # Enable if using SquirrelMail
port = http,https
filter = squirrelmail
logpath = /var/log/apache2/access.log
          /var/log/nginx/access.log
maxretry = 5
bantime = 1800
findtime = 300
action = iptables-multiport[name=squirrelmail, port="http,https"]

[roundcube]
# Protects Roundcube webmail interface
enabled = false  # Enable if using Roundcube
port = http,https
filter = roundcube-auth
logpath = /var/log/apache2/error.log
          /var/log/nginx/error.log
          /var/www/roundcube/logs/errors
maxretry = 5
bantime = 1800
findtime = 300
action = iptables-multiport[name=roundcube, port="http,https"]

# =============================================================================
# SPAM/MALWARE PROTECTION
# =============================================================================

[postfix-spam]
# Blocks IPs that send spam or trigger spam filters
enabled = true
port = smtp,465,587,submission
filter = postfix-spam
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 2
bantime = 14400  # 4 hours
findtime = 1800
action = iptables-multiport[name=postfix-spam, port="smtp,465,587,submission"]

[amavis]
# Protects against Amavis-detected threats
enabled = false  # Enable if using Amavis
port = smtp,465,587
filter = amavis
logpath = /var/log/mail.log
          /var/log/amavis.log
maxretry = 1
bantime = 86400  # 24 hours
findtime = 300
action = iptables-multiport[name=amavis, port="smtp,465,587"]

# =============================================================================
# DIRECTORY HARVEST ATTACK PROTECTION
# =============================================================================

[postfix-dha]
# Protects against Directory Harvest Attacks
enabled = true
port = smtp,465,587,submission
filter = postfix-dha
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 2
bantime = 7200
findtime = 600
action = iptables-multiport[name=postfix-dha, port="smtp,465,587,submission"]

# =============================================================================
# CUSTOM FILTERS (Define these in /etc/fail2ban/filter.d/)
# =============================================================================

# Note: You'll need to create corresponding filter files for some of these jails:

# /etc/fail2ban/filter.d/postfix-relay.conf
# [Definition]
# failregex = ^.* postfix/smtpd\[\d+\]: NOQUEUE: reject: .* Relay access denied.*from .*\[<HOST>\]
# ignoreregex =

# /etc/fail2ban/filter.d/postfix-spam.conf
# [Definition]
# failregex = ^.* postfix/cleanup\[\d+\]: .* reject: .* spam.*from .*\[<HOST>\]
#             ^.* postfix/smtpd\[\d+\]: .* reject: .* spam.*from .*\[<HOST>\]
# ignoreregex =

# /etc/fail2ban/filter.d/postfix-dha.conf
# [Definition]
# failregex = ^.* postfix/smtpd\[\d+\]: NOQUEUE: reject: .* User unknown.*from .*\[<HOST>\]
# ignoreregex =

# /etc/fail2ban/filter.d/roundcube-auth.conf
# [Definition]
# failregex = ^\[.*\] .* IMAP Error: Login failed for .* from <HOST>
#             ^\[.*\] .* Authentication failed for .* from <HOST>
# ignoreregex =

# =============================================================================
# RATE LIMITING FOR EMAIL SERVICES
# =============================================================================

[email-rate-limit]
# Rate limiting for excessive email connections
enabled = true
port = smtp,465,587,submission,pop3,pop3s,imap,imaps
filter = email-rate-limit
logpath = /var/log/mail.log
          /var/log/postfix.log
          /var/log/dovecot.log
maxretry = 50  # Allow more connections but detect floods
bantime = 1800
findtime = 300
action = iptables-multiport[name=email-rate-limit, port="smtp,465,587,submission,pop3,pop3s,imap,imaps"]

# =============================================================================
# GEOGRAPHIC BLOCKING (if using GeoIP)
# =============================================================================

[email-geo-block]
# Block connections from certain countries (configure as needed)
enabled = false  # Enable and configure based on your needs
port = smtp,465,587,submission,pop3,pop3s,imap,imaps
filter = email-geo-block
logpath = /var/log/mail.log
maxretry = 1
bantime = 86400
findtime = 60
action = iptables-multiport[name=email-geo-block, port="smtp,465,587,submission,pop3,pop3s,imap,imaps"]

# =============================================================================
# EMAIL BOMBER PROTECTION
# =============================================================================

[email-bomber]
# Protects against email bombing attacks
enabled = true
port = smtp,465,587,submission
filter = email-bomber
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 20  # Allow burst but detect flooding
bantime = 7200
findtime = 600
action = iptables-multiport[name=email-bomber, port="smtp,465,587,submission"]

# =============================================================================
# MONITORING AND ALERTING
# =============================================================================

# Configure email notifications for critical bans
[DEFAULT]
# Email notifications (configure your SMTP settings)
sender = fail2ban@%(domain)s
dest = admin@%(domain)s
destemail = admin@%(domain)s

# For high-security environments, consider:
# - Setting up SIEM integration
# - Implementing geographic IP blocking
# - Adding custom threat intelligence feeds
# - Monitoring for privilege escalation attempts
# - Regular security audits and log analysis

# =============================================================================
# USAGE INSTRUCTIONS
# =============================================================================

# 1. Copy relevant sections to /etc/fail2ban/jail.local
# 2. Create missing filter files in /etc/fail2ban/filter.d/
# 3. Adjust ports, paths, and thresholds for your environment
# 4. Test configuration: fail2ban-client reload
# 5. Monitor effectiveness: fail2ban-client status
# 6. Review logs regularly: tail -f /var/log/fail2ban.log

# =============================================================================
# SECURITY BEST PRACTICES
# =============================================================================

# 1. Regularly update fail2ban and mail server software
# 2. Monitor fail2ban logs for unusual patterns
# 3. Implement proper mail server hardening
# 4. Use strong authentication mechanisms (2FA where possible)
# 5. Regularly audit email accounts and permissions
# 6. Implement proper backup and disaster recovery
# 7. Monitor email server performance and logs
# 8. Keep email software and OS patches current
# 9. Implement proper firewall rules
# 10. Regular security assessments and penetration testing