{% extends "base.html" %}

{% block content %}
<section style="background-color: #f8f9fc; margin-top: 80px; padding: 80px 0; min-height: calc(100vh - 80px);">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">

                <!-- Header Section -->
                <div class="text-center mb-4">
                    <h2 class="section-title__heading mb-3">
                        üöÄ D√©ploiement en cours...
                    </h2>
                    <p class="welcome-content--l8__descriptions">
                        <span style="font-size: 22px;">
                            Votre application <strong>{{ subdomain }}.minipass.me</strong> est en cours de cr√©ation
                        </span>
                    </p>
                </div>

            <!-- Enhanced Terminal Card -->
            <div class="card mb-4" style="
                background: #000;
                border: none;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5), 0 6px 20px rgba(0, 0, 0, 0.4);
            ">
                <!-- Terminal Header (macOS style) -->
                <div style="
                    background: #2d2d2d;
                    padding: 10px 15px;
                    display: flex;
                    align-items: center;
                    border-bottom: 1px solid #1a1a1a;
                ">
                    <div style="display: flex; gap: 8px;">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: #ff5f56;"></div>
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: #ffbd2e;"></div>
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: #27c93f;"></div>
                    </div>
                    <div style="
                        flex: 1;
                        text-align: center;
                        color: #8b8b8b;
                        font-family: monospace;
                        font-size: 13px;
                    ">
                        MiniPass Deployment Console
                    </div>
                </div>

                <!-- Terminal Body -->
                <div id="terminal" style="
                    font-family: 'Courier New', Courier, monospace;
                    padding: 25px;
                    min-height: 400px;
                    max-height: 500px;
                    overflow-y: auto;
                    color: #00ff99;
                    font-size: 14px;
                    line-height: 1.6;
                    background: #000;
                ">
                    <div class="log-line">[INFO] Connecting to deployment server...</div>
                    <div class="log-line">[INFO] Verifying payment session...</div>
                </div>
            </div>

            </div>
        </div>
    </div>
</section>

<!-- Deployment Complete Modal -->
<div class="modal fade" id="deploymentCompleteModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <!-- Modal Header -->
            <div class="modal-header" style="border-bottom: 2px solid #f0f0f0; padding: 2rem 2rem 1.5rem;">
                <h4 class="modal-title w-100 text-center" style="font-weight: 700; color: #2c3e50; font-size: 1.75rem; margin: 0;">
                    D√©ploiement en cours
                </h4>
            </div>

            <!-- Modal Body -->
            <div class="modal-body" style="padding: 2rem 2.5rem;">
                <div class="text-center mb-4">
                    <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, #099a97 0%, #0d9488 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                </div>

                <h5 class="text-center mb-3" style="font-weight: 600; color: #2c3e50; font-size: 1.3rem;">
                    V√©rifiez votre bo√Æte de r√©ception
                </h5>

                <p class="text-center mb-4" style="color: #5a6c7d; font-size: 1rem; line-height: 1.6;">
                    Le d√©ploiement complet prend environ <strong style="color: #2c3e50;">10 minutes</strong>.
                </p>

                <div style="background: #f8f9fc; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #099a97;">
                    <p class="mb-2" style="color: #2c3e50; font-weight: 600; font-size: 0.95rem;">
                        Vous recevrez un email √† <strong id="customer-email" style="color: #099a97;"></strong> avec:
                    </p>
                    <ul class="mb-0" style="color: #5a6c7d; font-size: 0.95rem; line-height: 1.8; padding-left: 1.5rem;">
                        <li>Lien vers votre application</li>
                        <li>Identifiants de connexion</li>
                        <li>Documentation de configuration</li>
                    </ul>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer" style="border-top: 2px solid #f0f0f0; padding: 1.5rem 2rem;">
                <button type="button" class="btn w-100" onclick="window.location.href='/'" style="
                    background: linear-gradient(135deg, #099a97 0%, #0d9488 100%);
                    color: white;
                    font-weight: 600;
                    font-size: 1.1rem;
                    padding: 14px;
                    border-radius: 8px;
                    border: none;
                    transition: all 0.3s ease;
                ">
                    Retour √† la page d'accueil
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Configuration
const SESSION_ID = "{{ session_id }}";
const POLL_INTERVAL = 3000;  // 3 seconds
const MAX_DURATION = 10000; // 10 seconds
const REDIRECT_DELAY = 10000; // 10 seconds (reduced from 20)
const LOG_DISPLAY_DELAY = 200; // 200ms between each log line (faster, more realistic)

let pollingTimer = null;
let startTime = Date.now();
let redirectTimer = null;
let terminalCleared = false;  // Track if we've cleared initial messages
let lastLogCount = 0;  // Track how many logs we've displayed
let logQueue = [];  // Queue for progressive log display
let isDisplayingLogs = false;  // Flag to prevent concurrent display
let deploymentCompleted = false;  // Flag to track if deployment finished

// Terminal auto-scroll
function scrollTerminalToBottom() {
    const terminal = document.getElementById('terminal');
    terminal.scrollTop = terminal.scrollHeight;
}

// Add log line to terminal
function addLogLine(text) {
    const terminal = document.getElementById('terminal');
    const line = document.createElement('div');
    line.className = 'log-line';
    line.textContent = text;

    // Color coding based on log level
    if (text.includes('[OK]') || text.includes('[SUCCESS]')) {
        line.style.color = '#4ade80'; // Green
    } else if (text.includes('[ERROR]') || text.includes('[FAIL]')) {
        line.style.color = '#f87171'; // Red
    } else if (text.includes('[WARN]')) {
        line.style.color = '#fbbf24'; // Yellow
    } else {
        line.style.color = '#a3a3a3'; // Gray for [INFO]
    }

    terminal.appendChild(line);
    scrollTerminalToBottom();
}

// Clear initial loading messages
function clearTerminal() {
    const terminal = document.getElementById('terminal');
    terminal.innerHTML = '';
}

// Progressive log display - TRULY one by one from queue
async function displayLogsProgressively() {
    if (isDisplayingLogs || logQueue.length === 0) {
        return;
    }

    isDisplayingLogs = true;

    // Process logs ONE AT A TIME with delay between each
    while (logQueue.length > 0) {
        const logText = logQueue.shift();
        addLogLine(logText);

        // IMPORTANT: Wait before displaying next log
        await new Promise(resolve => setTimeout(resolve, LOG_DISPLAY_DELAY));
    }

    isDisplayingLogs = false;
}

// Show completion modal
function showCompletionModal(email) {
    // Stop polling
    if (pollingTimer) {
        clearInterval(pollingTimer);
    }

    // Set customer email in modal
    document.getElementById('customer-email').textContent = email || 'votre adresse';

    // Show Bootstrap modal
    const modal = new bootstrap.Modal(document.getElementById('deploymentCompleteModal'));
    modal.show();
}

// Fetch deployment logs
async function fetchLogs() {
    try {
        const response = await fetch(`/api/deployment-logs/${SESSION_ID}`);
        const data = await response.json();

        // Don't process if deployment already completed
        if (deploymentCompleted) {
            return;
        }

        // Clear initial messages ONLY ONCE on first real data
        if (data.status !== 'not_started' && !terminalCleared) {
            clearTerminal();
            terminalCleared = true;
        }

        // Add NEW logs to queue (not already displayed)
        if (terminalCleared && data.logs && data.logs.length > lastLogCount) {
            // Add only the new logs to the queue
            const newLogs = data.logs.slice(lastLogCount);
            newLogs.forEach(log => {
                logQueue.push(log);
            });
            lastLogCount = data.logs.length;

            // Start progressive display
            displayLogsProgressively();
        }

        // Store email for later use
        if (data.email) {
            document.getElementById('customer-email').textContent = data.email;
        }

        // Check if deployment completed or time exceeded
        const elapsed = Date.now() - startTime;

        if (data.status === 'completed' && !deploymentCompleted) {
            // Stop polling immediately
            if (pollingTimer) {
                clearInterval(pollingTimer);
            }

            // Add completion messages to queue
            logQueue.push('');
            logQueue.push('üéâ D√©ploiement termin√© avec succ√®s!');
            logQueue.push('üìß V√©rifiez votre email pour les d√©tails de connexion.');
            deploymentCompleted = true;

            // Display remaining logs then show completion modal after 2 seconds
            await displayLogsProgressively();
            setTimeout(() => showCompletionModal(data.email), 2000);
        } else if (elapsed >= MAX_DURATION && !deploymentCompleted) {
            // Stop polling after timeout
            if (pollingTimer) {
                clearInterval(pollingTimer);
            }

            // Add timeout messages to queue
            logQueue.push('');
            logQueue.push('‚è∞ D√©ploiement en cours...');
            logQueue.push('üìß Vous recevrez un email d√®s que tout sera pr√™t.');
            deploymentCompleted = true;

            // Display remaining logs then show completion modal after 2 seconds
            await displayLogsProgressively();
            setTimeout(() => showCompletionModal(data.email), 2000);
        }

    } catch (error) {
        console.error('Error fetching logs:', error);
        addLogLine('‚ö†Ô∏è Erreur de connexion au serveur. R√©essai...');
    }
}

// Start polling
function startPolling() {
    // Initial fetch
    fetchLogs();

    // Poll every 3 seconds
    pollingTimer = setInterval(() => {
        const elapsed = Date.now() - startTime;

        // Stop polling after MAX_DURATION
        if (elapsed >= MAX_DURATION) {
            clearInterval(pollingTimer);
            return;
        }

        fetchLogs();
    }, POLL_INTERVAL);

    // GUARANTEED modal after MAX_DURATION (independent of polling)
    // This ensures the modal ALWAYS shows, even if polling doesn't trigger it
    setTimeout(() => {
        if (!deploymentCompleted) {
            deploymentCompleted = true;
            if (pollingTimer) clearInterval(pollingTimer);
            logQueue.push('');
            logQueue.push('‚è∞ D√©ploiement en cours...');
            logQueue.push('üìß Vous recevrez un email d√®s que tout sera pr√™t.');
            displayLogsProgressively();
            setTimeout(() => {
                const email = document.getElementById('customer-email').textContent || 'votre adresse';
                showCompletionModal(email);
            }, 2000);
        }
    }, MAX_DURATION);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    if (SESSION_ID) {
        startPolling();
    } else {
        addLogLine('‚ùå Erreur: Session invalide');
        addLogLine('Redirection vers la page d\'accueil...');
        setTimeout(() => window.location.href = '/', 5000);
    }
});
</script>

<style>
.log-line {
    margin-bottom: 2px;
    opacity: 0;
    animation: terminalFadeIn 0.1s forwards;
    font-family: 'Courier New', Courier, monospace;
    line-height: 1.4;
}

@keyframes terminalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Custom scrollbar for terminal */
#terminal::-webkit-scrollbar {
    width: 8px;
}

#terminal::-webkit-scrollbar-track {
    background: #1a1a1a;
}

#terminal::-webkit-scrollbar-thumb {
    background: #4a4a4a;
    border-radius: 4px;
}

#terminal::-webkit-scrollbar-thumb:hover {
    background: #666;
}
</style>

{% endblock %}
