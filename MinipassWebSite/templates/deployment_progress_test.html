{% extends "base.html" %}

{% block content %}
<section style="background-color: #f8f9fc; margin-top: 80px; padding: 80px 0; min-height: calc(100vh - 80px);">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">

                <!-- Test Controls -->
                <div class="text-center mb-3">
                    <button id="restart-btn" class="btn btn-primary btn-sm" onclick="restartAnimation()">
                        ðŸ”„ Recommencer l'animation
                    </button>
                    <span class="badge bg-warning text-dark ms-2">MODE TEST</span>
                </div>

                <!-- Header Section -->
                <div class="text-center mb-4">
                    <h2 class="section-title__heading mb-3">
                        ðŸš€ DÃ©ploiement en cours...
                    </h2>
                    <p class="welcome-content--l8__descriptions">
                        <span style="font-size: 22px;">
                            Votre application <strong>test.minipass.me</strong> est en cours de crÃ©ation
                        </span>
                    </p>
                </div>

            <!-- Enhanced Terminal Card -->
            <div class="card mb-4" style="
                background: #000;
                border: none;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5), 0 6px 20px rgba(0, 0, 0, 0.4);
            ">
                <!-- Terminal Header (macOS style) -->
                <div style="
                    background: #2d2d2d;
                    padding: 10px 15px;
                    display: flex;
                    align-items: center;
                    border-bottom: 1px solid #1a1a1a;
                ">
                    <div style="display: flex; gap: 8px;">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: #ff5f56;"></div>
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: #ffbd2e;"></div>
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: #27c93f;"></div>
                    </div>
                    <div style="
                        flex: 1;
                        text-align: center;
                        color: #8b8b8b;
                        font-family: monospace;
                        font-size: 13px;
                    ">
                        MiniPass Deployment Console - TEST MODE
                    </div>
                </div>

                <!-- Terminal Body -->
                <div id="terminal" style="
                    font-family: 'Courier New', Courier, monospace;
                    padding: 25px;
                    min-height: 400px;
                    max-height: 500px;
                    overflow-y: auto;
                    color: #00ff99;
                    font-size: 14px;
                    line-height: 1.6;
                    background: #000;
                ">
                </div>
            </div>

            </div>
        </div>
    </div>
</section>

<!-- Deployment Complete Modal -->
<div class="modal fade" id="deploymentCompleteModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <!-- Modal Header -->
            <div class="modal-header" style="border-bottom: 2px solid #f0f0f0; padding: 2rem 2rem 1.5rem;">
                <h4 class="modal-title w-100 text-center" style="font-weight: 700; color: #2c3e50; font-size: 1.75rem; margin: 0;">
                    DÃ©ploiement en cours
                </h4>
            </div>

            <!-- Modal Body -->
            <div class="modal-body" style="padding: 2rem 2.5rem;">
                <div class="text-center mb-4">
                    <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, #099a97 0%, #0d9488 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                </div>

                <h5 class="text-center mb-3" style="font-weight: 600; color: #2c3e50; font-size: 1.3rem;">
                    VÃ©rifiez votre boÃ®te de rÃ©ception
                </h5>

                <p class="text-center mb-4" style="color: #5a6c7d; font-size: 1rem; line-height: 1.6;">
                    Le dÃ©ploiement complet prend environ <strong style="color: #2c3e50;">10 minutes</strong>.
                </p>

                <div style="background: #f8f9fc; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #099a97;">
                    <p class="mb-2" style="color: #2c3e50; font-weight: 600; font-size: 0.95rem;">
                        Vous recevrez un email Ã  <strong id="customer-email" style="color: #099a97;">test@example.com</strong> avec:
                    </p>
                    <ul class="mb-0" style="color: #5a6c7d; font-size: 0.95rem; line-height: 1.8; padding-left: 1.5rem;">
                        <li>Lien vers votre application</li>
                        <li>Identifiants de connexion</li>
                        <li>Documentation de configuration</li>
                    </ul>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer" style="border-top: 2px solid #f0f0f0; padding: 1.5rem 2rem;">
                <button type="button" class="btn w-100" onclick="window.location.href='/'" style="
                    background: linear-gradient(135deg, #099a97 0%, #0d9488 100%);
                    color: white;
                    font-weight: 600;
                    font-size: 1.1rem;
                    padding: 14px;
                    border-radius: 8px;
                    border: none;
                    transition: all 0.3s ease;
                ">
                    Retour Ã  la page d'accueil
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Configuration
const LOG_DISPLAY_DELAY = 200; // 200ms between each log line (faster, more realistic)

let logQueue = [];
let isDisplayingLogs = false;
let deploymentCompleted = false;

// Mock deployment logs - these will be displayed one by one
const MOCK_LOGS = [
    '[INFO] Connecting to deployment server...',
    '[INFO] Verifying payment session...',
    '[OK] Session validated successfully',
    '[INFO] Preparing environment...',
    '[INFO] Creating application directory...',
    '[INFO] Copying source files...',
    '[INFO] Configuring database...',
    '[INFO] Generating security keys...',
    '[INFO] Configuring subdomain test.minipass.me...',
    '[INFO] Creating email account...',
    '[INFO] Configuring SSL/TLS certificates...',
    '[INFO] Building Docker image...',
    '[INFO] Installing Python dependencies...',
    '[INFO] Optimizing resources...',
    '[INFO] Deploying container on port 8001...',
    '[OK] Container started successfully',
    '[SUCCESS] Deployment completed successfully',
    '[INFO] Check your email for connection details'
];

// Terminal auto-scroll
function scrollTerminalToBottom() {
    const terminal = document.getElementById('terminal');
    terminal.scrollTop = terminal.scrollHeight;
}

// Add log line to terminal
function addLogLine(text) {
    const terminal = document.getElementById('terminal');
    const line = document.createElement('div');
    line.className = 'log-line';
    line.textContent = text;

    // Color coding based on log level
    if (text.includes('[OK]') || text.includes('[SUCCESS]')) {
        line.style.color = '#4ade80'; // Green
    } else if (text.includes('[ERROR]') || text.includes('[FAIL]')) {
        line.style.color = '#f87171'; // Red
    } else if (text.includes('[WARN]')) {
        line.style.color = '#fbbf24'; // Yellow
    } else {
        line.style.color = '#a3a3a3'; // Gray for [INFO]
    }

    terminal.appendChild(line);
    scrollTerminalToBottom();
}

// Clear terminal
function clearTerminal() {
    const terminal = document.getElementById('terminal');
    terminal.innerHTML = '';
}

// Progressive log display - TRULY one by one
async function displayLogsProgressively() {
    console.log('displayLogsProgressively called, queue length:', logQueue.length, 'isDisplaying:', isDisplayingLogs);

    if (isDisplayingLogs || logQueue.length === 0) {
        console.log('Exiting early - already displaying or empty queue');
        return;
    }

    isDisplayingLogs = true;
    console.log('Starting log display...');

    // Display logs ONE AT A TIME with delay between each
    for (let i = 0; i < logQueue.length; i++) {
        const logText = logQueue[i];
        addLogLine(logText);

        // Check if this is the deployment trigger
        if (logText.includes('Deploying container')) {
            // Wait 2 seconds then trigger completion modal
            await new Promise(resolve => setTimeout(resolve, 2000));
            deploymentCompleted = true;
            showCompletionModal('test@example.com');
            break;
        }

        // Wait before displaying next log (IMPORTANT!)
        await new Promise(resolve => setTimeout(resolve, LOG_DISPLAY_DELAY));
    }

    isDisplayingLogs = false;
}

// Show completion modal
function showCompletionModal(email) {
    // Set customer email in modal
    document.getElementById('customer-email').textContent = email || 'test@example.com';

    // Show Bootstrap modal
    const modal = new bootstrap.Modal(document.getElementById('deploymentCompleteModal'));
    modal.show();
}

// Restart animation
function restartAnimation() {
    // Reset state
    deploymentCompleted = false;
    isDisplayingLogs = false;
    logQueue = [...MOCK_LOGS]; // Copy mock logs

    // Clear UI
    clearTerminal();

    // Close modal if open
    const modalElement = document.getElementById('deploymentCompleteModal');
    const modalInstance = bootstrap.Modal.getInstance(modalElement);
    if (modalInstance) {
        modalInstance.hide();
    }

    // Start animation
    displayLogsProgressively();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    console.log('Page loaded, starting animation...');
    console.log('Mock logs count:', MOCK_LOGS.length);
    // Auto-start the animation
    restartAnimation();
});
</script>

<style>
.log-line {
    margin-bottom: 2px;
    opacity: 0;
    animation: terminalFadeIn 0.1s forwards;
    font-family: 'Courier New', Courier, monospace;
    line-height: 1.4;
}

@keyframes terminalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Custom scrollbar for terminal */
#terminal::-webkit-scrollbar {
    width: 8px;
}

#terminal::-webkit-scrollbar-track {
    background: #1a1a1a;
}

#terminal::-webkit-scrollbar-thumb {
    background: #4a4a4a;
    border-radius: 4px;
}

#terminal::-webkit-scrollbar-thumb:hover {
    background: #666;
}
</style>

{% endblock %}
