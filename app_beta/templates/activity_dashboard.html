{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<style>
  .table-responsive {
    overflow: visible !important;
    position: relative;
  }
  .table-responsive .dropdown {
    position: relative;
  }
  .table-responsive .dropdown-menu {
    z-index: 1060;
  }
</style>




<style>
  /* ðŸ”§ Resize + flush image */
  .activity-img-container {
    height: 160px !important;
    padding: 0 !important;
    margin: 0 !important;
  }
  
  .activity-img-container img {
    height: 100% !important;
    width: 100% !important;
    object-fit: cover !important;
    display: block !important;
    margin: 0 !important;
    padding: 0 !important;
    border: 0 !important;
  }
  
  /* Optional: constrain text container height */
  .activity-info {
    height: 160px !important;
    overflow: hidden !important;
  }
  </style>
  





  <!-- ðŸ§Š Compact Activity Card -->
  <div class="card shadow-sm border mb-4 overflow-hidden">
    <div class="row g-0 align-items-stretch" style="height: 160px;">
      <!-- ðŸ“‹ Left Side: Info -->
      <div class="col-md-8 p-3 d-flex flex-column justify-content-between activity-info">
        <div>

          <h2 class="card-title mb-2 fs-2 fw-bold"> <i class="ti ti-rocket me-1"></i> {{ activity.name }}</h2>

          <p class="text-muted mb-2 small">{{ activity.description or "No description provided." }}</p>
  
          <!-- ðŸ“Š KPIs -->
          <div class="d-flex flex-wrap align-items-center text-body small gap-3 fw-medium">
            {% if activity.start_date %}
              <div>
                <i class="ti ti-calendar-event me-1"></i>
                {{ activity.start_date.strftime('%Y-%m-%d') }}
                {% if activity.end_date %}@ {{ activity.end_date.strftime('%Y-%m-%d') }}{% endif %}
              </div>
            {% endif %}
            <div><i class="ti ti-ticket me-1"></i>{{ passes | length }}</div>
            {% set revenue = passes | selectattr('paid', 'equalto', True) | map(attribute='sold_amt') | sum %}
            <div><i class="ti ti-currency-dollar me-1"></i>{{ revenue | round(2) }}</div>
          </div>
        </div>
      </div>
  
      <!-- ðŸ–¼ Right Side: Image + Edit -->
      <div class="col-md-4 activity-img-container position-relative">
        <a href="{{ url_for('edit_activity', activity_id=activity.id) }}"
           class="btn btn-outline-primary position-absolute top-0 end-0 m-2 z-3">
          <i class="ti ti-pencil"></i> Edit
        </a>
        <img src="{{ url_for('static', filename='uploads/activity_images/' ~ (activity.image_filename or 'placeholder.jpg')) }}"
             alt="Activity Image">
      </div>
    </div>
  
    <!-- ðŸ“‰ Bottom Progress Bar -->
    {% set goal = activity.goal_revenue or 0 %}
    {% set pct = ((revenue / goal) * 100) if goal > 0 else 0 %}
    <div class="progress progress-xs" style="height: 4px !important;">
      <div class="progress-bar bg-blue" style="width: {{ pct | round(1) }}% !important;"></div>
    </div>
  </div>
  


 






<!-- ðŸŸ¢ Signups Table (pending only) -->

{% set pending_signups = signups | selectattr('status', 'equalto', 'pending') | list %}
{% if pending_signups %}

<div class="card mb-4 d-none d-md-block">  

  <div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="card-title">Activity Signups (Pending)</h3>
    <span class="badge bg-yellow-lt">{{ pending_signups|length }} pending</span>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table card-table table-vcenter" id="signupTable">
        <thead>
          <tr>
            <th>Name</th>
            <th class="d-none d-md-table-cell">Activity</th>
            <th class="d-none d-md-table-cell">Email</th>
            <th class="d-none d-md-table-cell">Signup Date</th>
            <th class="d-none d-md-table-cell">Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for s in pending_signups %}
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <span class="avatar me-2 rounded" style="background-image:url('https://www.gravatar.com/avatar/{{ s.user.email|lower|trim|encode_md5 }}?d=identicon')"></span>
                {{ s.user.name }}
              </div>
            </td>
            <td class="d-none d-md-table-cell">{{ s.activity.name if s.activity else '-' }}</td>
            <td class="d-none d-md-table-cell">{{ s.user.email }}</td>
            <td class="d-none d-md-table-cell">{{ s.signed_up_at.strftime('%Y-%m-%d') }}</td>
            <td class="d-none d-md-table-cell">
              {% if s.paid %}
                <span class="badge bg-green-lt">Paid</span>
              {% else %}
                <span class="badge bg-red-lt">Unpaid</span>
              {% endif %}
            </td>
            <td>
              <div class="dropdown">
                <a href="#" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">Actions</a>
                <div class="dropdown-menu">
                  <button type="button" class="dropdown-item text-success" data-bs-toggle="modal" data-bs-target="#approve-modal-{{ s.id }}">
                    <i class="ti ti-check me-2"></i>Approve & Create Passport
                  </button>
                  <button type="button" class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#reject-modal-{{ s.id }}">
                    <i class="ti ti-x me-2"></i>Reject
                  </button>
                  <button type="button" class="dropdown-item text-warning" data-bs-toggle="modal" data-bs-target="#cancel-modal-{{ s.id }}">
                    <i class="ti ti-ban me-2"></i>Cancel
                  </button>
                </div>
              </div>
            </td>
          </tr>

          <!-- âœ… Modals placed correctly inside loop -->
          <tr>
            <td colspan="6">
              <div class="modal modal-blur fade" id="approve-modal-{{ s.id }}" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <div class="modal-status bg-success"></div>
                    <div class="modal-body text-center py-4">
                      <i class="ti ti-check icon mb-2 text-success" style="font-size: 2rem;"></i>
                      <h3>Approve Signup</h3>
                      <div class="text-muted">Approve and create passport for {{ s.user.name }}?</div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-link w-100" data-bs-dismiss="modal">Cancel</button>
                      <a href="{{ url_for('approve_and_create_pass', signup_id=s.id) }}" class="btn btn-success w-100">Yes, Approve</a>
                    </div>
                  </div>
                </div>
              </div>

              <div class="modal modal-blur fade" id="reject-modal-{{ s.id }}" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <div class="modal-status bg-danger"></div>
                    <div class="modal-body text-center py-4">
                      <i class="ti ti-x icon mb-2 text-danger" style="font-size: 2rem;"></i>
                      <h3>Reject Signup</h3>
                      <div class="text-muted">Reject signup from {{ s.user.name }}?</div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-link w-100" data-bs-dismiss="modal">Cancel</button>
                      <form method="POST" action="{{ url_for('update_signup_status', signup_id=s.id) }}" class="w-100">
                        <input type="hidden" name="status" value="rejected">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger w-100">Yes, Reject</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

              <div class="modal modal-blur fade" id="cancel-modal-{{ s.id }}" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <div class="modal-status bg-warning"></div>
                    <div class="modal-body text-center py-4">
                      <i class="ti ti-ban icon mb-2 text-warning" style="font-size: 2rem;"></i>
                      <h3>Cancel Signup</h3>
                      <div class="text-muted">Cancel signup from {{ s.user.name }}?</div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-link w-100" data-bs-dismiss="modal">Back</button>
                      <form method="POST" action="{{ url_for('update_signup_status', signup_id=s.id) }}" class="w-100">
                        <input type="hidden" name="status" value="cancelled">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-warning w-100">Yes, Cancel</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}








<!-- ðŸ”Ž Search + Add New -->
<div class="card mb-3">
  <div class="card-body">
    <h3 class="card-title mb-3"><i class="ti ti-filter me-2"></i>Manage Passes</h3>
    <div class="row g-2 align-items-center">
      <div class="col-12 col-md-auto">
        <a href="{{ url_for('create_passport') }}" class="btn btn-primary w-100 w-md-auto">
          <i class="ti ti-plus"></i> Add New
        </a>
      </div>
      <div class="col-12 col-md-auto">
        <a href="{{ url_for('scan_qr') }}" class="btn btn-secondary w-100 w-md-auto">
          <i class="ti ti-scan"></i> Scan Pass
        </a>
      </div>
      <div class="col-12 col-md">
        <div class="input-icon">
          <span class="input-icon-addon"><i class="ti ti-search"></i></span>
          <input type="text" id="searchBox" class="form-control" placeholder="Search by User Name..." />
        </div>
      </div>
    </div>
  </div>
</div>




{# ------------------------------ #}
{# ðŸ›‚ Passport Table (refactored) #}
{# ------------------------------ #}


{% if passes %}
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h3 class="card-title">Active or Unpaid Passports</h3>
      <span class="badge bg-green-lt">{{ passes|length }} total</span>
    </div>
    <div class="table-responsive">
      <table class="table card-table table-vcenter" id="passportTable">
        <thead>
          <tr>
            <th>User</th>

            <th class="d-table-cell d-md-none">State</th>

            <th class="d-none d-md-table-cell">Activity</th>
            <th class="d-none d-md-table-cell">Created</th>
            <th class="d-none d-md-table-cell">Remaining</th>
            <th class="d-none d-md-table-cell">Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for p in passes %}
          <tr>


            <td>
              <div class="d-flex align-items-center">
                <span class="avatar me-2 rounded"
                      style="width: 40px; height: 40px; min-width: 40px; flex-shrink: 0; background-size: cover; background-image: url('https://www.gravatar.com/avatar/{{ p.user.email|lower|trim|encode_md5 }}?d=identicon');"></span>
                {{ p.user.name }}
              </div>
            </td>




            <td class="d-table-cell d-md-none">
              {% if p.paid %}
                <span class="badge bg-green-lt">{{ p.uses_remaining }}</span>
              {% else %}
                <span class="badge bg-red-lt">{{ p.uses_remaining }}</span>
              {% endif %}
            </td>
            

            <td class="d-none d-md-table-cell">{{ p.activity.name if p.activity else '-' }}</td>
            <td class="d-none d-md-table-cell">{{ p.created_dt.strftime('%Y-%m-%d') }}</td>
            <td class="d-none d-md-table-cell">{{ p.uses_remaining }}</td>
            <td class="d-none d-md-table-cell">
              {% if p.paid %}<span class="badge bg-green-lt">Paid</span>
              {% else %}<span class="badge bg-red-lt">Unpaid</span>
              {% endif %}
            </td>
            <td>
              <div class="dropdown">
                <a href="#" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">Actions</a>
                <div class="dropdown-menu" style="z-index:1050;">
                  <button type="button" class="dropdown-item text-primary" data-bs-toggle="modal" data-bs-target="#redeem-modal-{{ p.id }}">
                    <i class="ti ti-check me-2"></i>Redeem
                  </button>
                  <a class="dropdown-item text-info" href="{{ url_for('show_pass', pass_code=p.pass_code) }}">
                    <i class="ti ti-check me-2"></i>View & Redeem
                  </a>
                  <a class="dropdown-item" href="{{ url_for('edit_passport', passport_id=p.id) }}">
                    <i class="ti ti-pencil me-2"></i>Edit
                  </a>
                  {% if not p.paid %}
                  <button type="button" class="dropdown-item text-success" data-bs-toggle="modal" data-bs-target="#mark-paid-modal-{{ p.id }}">
                    <i class="ti ti-currency-dollar me-2"></i> Mark as Paid
                  </button>
                  {% endif %}
                </div>
              </div>

              <!-- âœ… Redeem Modal -->
              <div class="modal modal-blur fade" id="redeem-modal-{{ p.id }}" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <div class="modal-status bg-primary"></div>
                    <div class="modal-body text-center py-4">
                      <i class="ti ti-check icon mb-2 text-primary" style="font-size: 2rem;"></i>
                      <h3>Redeem Session</h3>
                      <div class="text-muted">Redeem 1 session from {{ p.user.name }}'s passport?</div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-link w-100" data-bs-dismiss="modal">Cancel</button>
                      <form method="POST" action="{{ url_for('redeem_passport', pass_code=p.pass_code) }}" class="w-100">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-primary w-100">Yes, Redeem</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

              {% if not p.paid %}
              <div class="modal modal-blur fade" id="mark-paid-modal-{{ p.id }}" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <div class="modal-status bg-success"></div>
                    <div class="modal-body text-center py-4">
                      <i class="ti ti-currency-dollar icon mb-2 text-success" style="font-size: 2rem;"></i>
                      <h3>Confirm Payment</h3>
                      <div class="text-muted">Mark {{ p.user.name }}'s passport as paid?</div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-link w-100" data-bs-dismiss="modal">Cancel</button>
                      <form method="POST" action="{{ url_for('mark_passport_paid', passport_id=p.id) }}" class="w-100">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-success w-100">Yes, mark as paid</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}
  <div class="alert alert-warning text-center mt-4">
    No active or unpaid passports found for this activity.
  </div>
{% endif %}




<!-- ðŸ”˜ Floating Add Button (Mobile Only) -->
<a href="{{ url_for('create_passport') }}"
   class="btn btn-primary rounded-circle shadow d-md-none p-0 position-fixed"
   id="mobileAddBtn"
   style="bottom: 80px; right: 20px; z-index: 1055; width: 56px; height: 56px; display: none;">
  <div class="d-flex justify-content-center align-items-center" style="width: 100%; height: 100%;">
    <i class="ti ti-plus" style="font-size: 24px;"></i>
  </div>
</a>








{% endblock %}



{% block scripts %}

 
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchBox = document.getElementById('searchBox');
    const passportTable = document.getElementById('passportTable').getElementsByTagName('tbody')[0];

    searchBox.addEventListener('input', function() {
        const filter = searchBox.value.toLowerCase();
        const rows = passportTable.getElementsByTagName('tr');

        Array.from(rows).forEach(function(row) {
            const username = row.querySelector('td').innerText.toLowerCase();
            if (username.includes(filter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    const rowsPerPage = 10;
    let currentPage = 1;

    function paginateTable(tableBody) {
        const rows = tableBody.getElementsByTagName('tr');
        const totalPages = Math.ceil(rows.length / rowsPerPage);

        function renderPage(page) {
            Array.from(rows).forEach((row, index) => {
                if (index >= (page - 1) * rowsPerPage && index < page * rowsPerPage) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function createPaginationControls() {
            const card = tableBody.closest('.card');
            const cardFooter = document.createElement('div');
            cardFooter.className = 'card-footer d-flex align-items-center';

            const paginationContainer = document.createElement('ul');
            paginationContainer.className = 'pagination m-0 ms-auto';

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = 'page-item' + (i === currentPage ? ' active' : '');

                const button = document.createElement('a');
                button.className = 'page-link';
                button.href = '#';
                button.textContent = i;
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentPage = i;
                    updatePagination();
                });

                li.appendChild(button);
                paginationContainer.appendChild(li);
            }

            cardFooter.appendChild(paginationContainer);
            card.appendChild(cardFooter);
        }

        function updatePagination() {
            renderPage(currentPage);
            const paginationButtons = document.querySelectorAll('.pagination .page-item');
            paginationButtons.forEach((item, index) => {
                item.classList.toggle('active', index === currentPage - 1);
            });
        }

        renderPage(currentPage);
        createPaginationControls();
    }

    paginateTable(passportTable);
});
</script>
 



<script>
  window.addEventListener('DOMContentLoaded', function () {
    const mobileAddBtn = document.getElementById('mobileAddBtn');
  
    function toggleAddButton() {
      if (window.scrollY > 150) {
        mobileAddBtn.style.setProperty('display', 'block', 'important');
      } else {
        mobileAddBtn.style.setProperty('display', 'none', 'important');
      }
    }
  
    // Initial check
    toggleAddButton();
  
    // Respond to scroll
    window.addEventListener('scroll', toggleAddButton);
  });
  </script>
  




{% endblock %}
