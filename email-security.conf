# Email Security Jail Configuration for Fail2Ban
# Enhanced email service protection with comprehensive monitoring
#
# Place this file in /etc/fail2ban/jail.d/email-security.conf
# Restart fail2ban after installation: sudo systemctl restart fail2ban
#
# Author: Python DevOps Automation Specialist
# Created: 2025-08-02
# Version: 2.0.0 (Security Enhanced)

# =============================================================================
# POSTFIX SECURITY JAILS
# =============================================================================

[postfix-sasl]
# Protect against SMTP authentication brute force attacks
enabled = true
port = smtp,465,587,submission
filter = postfix-sasl
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 3
findtime = 600
bantime = 3600
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

[postfix-rbl]
# Protect against RBL bypass attempts and reputation attacks
enabled = true
port = smtp,465,587,submission
filter = postfix-rbl
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 2
findtime = 300
bantime = 7200
ignoreip = 127.0.0.1/8 ::1

[postfix-relay]
# Prevent unauthorized mail relay attempts
enabled = true
port = smtp,465,587,submission
filter = postfix-relay
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 2
findtime = 600
bantime = 14400
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

[postfix-spam]
# Block spam injection attempts and content filtering bypasses
enabled = true
port = smtp,465,587,submission
filter = postfix-spam
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 2
findtime = 900
bantime = 21600
ignoreip = 127.0.0.1/8 ::1

[postfix-ratelimit]
# Protect against excessive connection rates
enabled = true
port = smtp,465,587,submission
filter = postfix-ratelimit
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 5
findtime = 300
bantime = 1800
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

# =============================================================================
# DOVECOT SECURITY JAILS
# =============================================================================

[dovecot]
# Protect against IMAP/POP3 authentication attacks
enabled = true
port = pop3,pop3s,imap,imaps,submission,465,sieve
filter = dovecot
logpath = /var/log/mail.log
          /var/log/dovecot.log
          /var/log/dovecot-auth.log
maxretry = 3
findtime = 600
bantime = 3600
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

[dovecot-auth]
# Enhanced protection for Dovecot authentication failures
enabled = true
port = pop3,pop3s,imap,imaps,submission,465,sieve
filter = dovecot-auth
logpath = /var/log/dovecot-auth.log
          /var/log/mail.log
maxretry = 3
findtime = 600
bantime = 7200
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

[dovecot-pop3-imap]
# Specific protection for POP3/IMAP brute force
enabled = true
port = pop3,pop3s,imap,imaps
filter = dovecot-pop3-imap
logpath = /var/log/dovecot.log
          /var/log/mail.log
maxretry = 4
findtime = 900
bantime = 5400
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

# =============================================================================
# EXIM SECURITY JAILS (if using Exim instead of Postfix)
# =============================================================================

[exim]
# Protect Exim SMTP service
enabled = false
port = smtp,465,587,submission
filter = exim
logpath = /var/log/exim4/mainlog
maxretry = 3
findtime = 600
bantime = 3600
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

[exim-spam]
# Protect against Exim spam injection
enabled = false
port = smtp,465,587,submission
filter = exim-spam
logpath = /var/log/exim4/mainlog
maxretry = 2
findtime = 900
bantime = 21600
ignoreip = 127.0.0.1/8 ::1

# =============================================================================
# COURIER SECURITY JAILS (if using Courier)
# =============================================================================

[courier-smtp]
# Protect Courier SMTP service
enabled = false
port = smtp,465,587,submission
filter = courier-smtp
logpath = /var/log/mail.log
maxretry = 3
findtime = 600
bantime = 3600
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

[courier-auth]
# Protect Courier authentication
enabled = false
port = pop3,pop3s,imap,imaps
filter = courier-auth
logpath = /var/log/mail.log
maxretry = 3
findtime = 600
bantime = 3600
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

# =============================================================================
# ROUNDCUBE WEBMAIL SECURITY
# =============================================================================

[roundcube-auth]
# Protect Roundcube webmail authentication
enabled = true
port = http,https
filter = roundcube-auth
logpath = /var/log/roundcube/errors.log
          /var/log/apache2/error.log
          /var/log/nginx/error.log
maxretry = 5
findtime = 900
bantime = 3600
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

# =============================================================================
# SQUIRRELMAIL SECURITY
# =============================================================================

[squirrelmail]
# Protect SquirrelMail webmail
enabled = false
port = http,https
filter = squirrelmail
logpath = /var/log/apache2/access.log
          /var/log/nginx/access.log
maxretry = 5
findtime = 900
bantime = 3600
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

# =============================================================================
# GENERIC EMAIL SECURITY RULES
# =============================================================================

[email-brute-force]
# Generic email brute force protection
enabled = true
port = smtp,pop3,imap,465,587,993,995,submission
filter = email-brute-force
logpath = /var/log/mail.log
          /var/log/auth.log
maxretry = 5
findtime = 1200
bantime = 7200
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

[email-dos]
# Protect against email-based DoS attacks
enabled = true
port = smtp,pop3,imap,465,587,993,995,submission
filter = email-dos
logpath = /var/log/mail.log
maxretry = 10
findtime = 300
bantime = 3600
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

# =============================================================================
# ADVANCED EMAIL THREAT PROTECTION
# =============================================================================

[email-directory-harvest]
# Protect against directory harvest attacks
enabled = true
port = smtp,465,587,submission
filter = email-directory-harvest
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 3
findtime = 600
bantime = 14400
ignoreip = 127.0.0.1/8 ::1

[email-content-filter-bypass]
# Detect attempts to bypass content filtering
enabled = true
port = smtp,465,587,submission
filter = email-content-filter-bypass
logpath = /var/log/mail.log
          /var/log/amavis.log
          /var/log/spamassassin.log
maxretry = 2
findtime = 900
bantime = 21600
ignoreip = 127.0.0.1/8 ::1

[email-reputation-bypass]
# Detect reputation system bypass attempts
enabled = true
port = smtp,465,587,submission
filter = email-reputation-bypass
logpath = /var/log/mail.log
          /var/log/postfix.log
maxretry = 1
findtime = 300
bantime = 43200
ignoreip = 127.0.0.1/8 ::1

# =============================================================================
# ENHANCED LOGGING AND MONITORING
# =============================================================================

# Email Security Monitoring Configuration
# These settings enhance the logging and monitoring capabilities
# of the email security jails for better threat detection

# Increase logging verbosity for email-related events
# Add to your mail server configuration:
#
# Postfix (/etc/postfix/main.cf):
# smtp_tls_loglevel = 1
# smtpd_tls_loglevel = 1
# 
# Dovecot (/etc/dovecot/conf.d/10-logging.conf):
# auth_verbose = yes
# auth_debug = yes
# mail_debug = yes

# =============================================================================
# CONFIGURATION NOTES
# =============================================================================

# 1. Adjust findtime and bantime values based on your security requirements
# 2. Modify ignoreip to include your trusted networks
# 3. Enable/disable specific jails based on your mail server setup
# 4. Monitor fail2ban logs: tail -f /var/log/fail2ban.log
# 5. Test configuration: fail2ban-client reload
# 6. View jail status: fail2ban-client status [jail-name]

# Ban time recommendations:
# - Authentication failures: 1-4 hours
# - Relay attempts: 4-12 hours  
# - Spam injection: 6-24 hours
# - Directory harvest: 12-48 hours
# - Reputation bypass: 12-48 hours

# Security considerations:
# - Regularly review banned IPs for patterns
# - Monitor for distributed attacks across multiple IPs
# - Consider implementing geographic IP blocking for high-risk regions
# - Use whitelisting for trusted mail servers and services
# - Implement DMARC, SPF, and DKIM for additional email security